<!DOCTYPE html><html lang="en"><head><title>@siva | Scaling Gulp</title><meta property="og:title" content="Scaling Gulp"><meta property="og:site_name" content="@siva"><meta property="og:url" content="https://sivasubramanyam.me/scaling-gulp"><meta property="og:description" content="How Gulp can be (re)used for very large projects"><meta name="description" content="How Gulp can be (re)used for very large projects"><meta charset="utf-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><link rel="apple-touch-icon" sizes="57x57" href="/static/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/static/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/static/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/static/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/static/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/static/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/static/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/static/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/static/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"><meta name="msapplication-TileImage" content="/static/favicons/ms-icon-144x144.png"><meta name="keywords" content="sivasubramanyam,sivasubramanyam.me"><meta name="author" content="Sivasubramanyam A"><meta name="viewport" content="width=device-width,initial-scale=1"><title>@siva</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-57141163-3"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-57141163-3');</script><script>isWebp = () => document.createElement('canvas').toDataURL('image/webp').startsWith('data:image/webp');
  if (isWebp()) {
    let html = document.getElementsByTagName('html')[0];
    html.className = 'webp';
  }</script><link href="/static/css/styles-3c7ff35c28.css" rel="stylesheet" type="text/css"><link href="/static/css/ajanta-f742d71aac.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/js/highlight/styles/github-gist-6a5d39bb21.css" type="text/css"><script src="/static/js/highlight/highlight.pack-92445837db.js"></script></head><body><div class="content hero hero-post"><div class="navbr navbr-primary"><a href="/">@siva</a></div><div class="navbr navbr-secondary">April, 2018 - Tagged &nbsp;&nbsp;-<a href="/tag/Gulp/">&nbsp;&nbsp;Gulp</a> &nbsp;&nbsp;-<a href="/tag/Node/">&nbsp;&nbsp;Node</a></div><div class="helloWorld"><div class="hello hello-post">Scaling Gulp</div></div></div><main role="main"><div class="container posts"><div class="content"><p>About a year back, I started to work on unifying the development, build and deployment process of several websites. All these websites had almost the same structure and dependencies and were using <a href="https://gulpjs.com/">Gulp</a>.</p><p>The main problem was the verbosity of the gulp tasks and code duplication. Each gulpfile was over 250 lines long and was incomprehensible even to experienced developers. The same gulpfile was present in each repository and making one change meant changing it in all the repos.</p><p>Consider this <code>gulpfile.js</code>.</p><pre>
  const gulp = require('gulp');
  const pug = require('gulp-pug');
  const less = require('gulp-less');
  const minifyCSS = require('gulp-csso');
  const concat = require('gulp-concat');
  const sourcemaps = require('gulp-sourcemaps');

  gulp.task('html', function() {
    return gulp.src('client/templates/*.pug')
      .pipe(pug())
      .pipe(gulp.dest('build/html'));
  });

  gulp.task('css', function() {
    return gulp.src('client/templates/*.less')
      .pipe(less())
      .pipe(minifyCSS())
      .pipe(gulp.dest('build/css'));
  });

  gulp.task('js', function() {
    return gulp.src('client/javascript/*.js')
      .pipe(sourcemaps.init())
      .pipe(concat('app.min.js'))
      .pipe(sourcemaps.write())
      .pipe(gulp.dest('build/js'));
  });

  gulp.task('default', [ 'html', 'css', 'js' ]);
</pre><p>Ugh. The largest contributor to the verbosity is the task definition. Fortunately, this could easily be addressed by moving out the tasks to separate files.</p><p>For example,</p><pre>
  const gulp = require('gulp');

  const getTask = (task) => {
    return require(`./${task}`);
  }

  gulp.task('html', getTask('html');
  gulp.task('css', getTask('css');
  gulp.task('js', getTask('js');
  gulp.task('default', [ 'html', 'css', 'js' ]);
</pre><p>and</p><pre>
  module.exports = function() {
    return function() {
      const pug = require('gulp-pug');
      return gulp.src('client/templates/*.pug')
        .pipe(pug())
        .pipe(gulp.dest('build/html'));
    }
  }
</pre><p>accomplishes the same thing!</p><p>You can see that the gulpfile is now simpler and the tasks act as separate modules which I feel is much more intuitive than putting them all in the same place.</p><p>As an added bonus, requiring <code>gulp-pug</code> inside the task this way makes sure that it will be required only when the task is actually run. <code>require()</code> is expensive and when you require a lot of modules in plain gulpfiles, they tend to slow down the startup. But by moving these to tasks and in a way, lazy-requiring them, you can see significant performance gains(especially on large websites).</p><p>In days of Gulp 3, the task ordering <code>gulp.task('default', ['html', 'css', 'js']);</code> was even more confusing but was largely solved by plugins such as <a href="https://www.npmjs.com/package/gulp-sequence">gulp-sequence</a>.</p><p>One another signifact thing that was done was to package this gulpfile(and its associated tasks and utils) into an NPM package. The consuming websites were then asked to provide a configuration file that this package could simply require. We now had one gulpfile for all websites and this meant, there was just one place where all our efforts were focussed on. By adding <code>./gulpfile</code> to the <code>package.json</code>s <code>bin</code> field, we could call the tasks as <code>myFastGulp taskName</code>.</p><p>For example,</p><pre>
  return gulp.src('websiteA/templates/*.pug')
    .pipe(pug())
    .pipe(gulp.dest('build/html'));
</pre><p>was changed to</p><pre>
  const path = require('path');
  const config = require(path.join(process.cwd(), 'myFastGulp.js'));

  return gulp.src(`${config.websiteName}/client/templates/*.pug`)
    .pipe(pug())
    .pipe(gulp.dest('build/html'));
</pre><p>In some cases like copying a large number of files(in the range of tens of thousands), gulp tended to be very slow. In these cases, just using an equivalent NPM package(or just plain Node's <code>fs</code>) accelerated things. <code>gulp-util</code> which is used by most packages for Gulp 3 and by gulp itself for logging was also slowing down gulp's startup by about 4-5 seconds. Removing it and using the excellent <a href="https://github.com/sindresorhus/ora">ora</a> and <a href="https://www.npmjs.com/package/chalk">chalk</a> also helped in accelerating Gulp's speed(especially startup).</p><p>Happy gulping!</p><p>PS: I highly recommend that you guys checkout <a href="https://github.com/Jaguard/time-require/">time-require</a> to profile your startup times(even in your non-Gulp projects). You will be in for surprises.</p></div></div></main><footer><div class="row footer-contents"><div class="col-md-12 copyright">2018 &copy; Sivasubramanyam A <a href="http://twitter.com/astronomersiva" class="social" aria-label="twitter"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg> </a>/ <a href="http://github.com/astronomersiva" class="social" aria-label="github"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></a></div></div></footer><style>@font-face {
    font-family: 'Source Sans Pro';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: local('Source Sans Pro Regular'), local('SourceSansPro-Regular'), url(https://fonts.gstatic.com/s/sourcesanspro/v11/ODelI1aHBYDBqgeIAH2zlJbPFduIYtoLzwST68uhz_Y.woff2) format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2212, U+2215;
  }</style><script defer="defer" src="/static/js/ajanta-dddb098315.js"></script><script defer="defer">let images = document.getElementsByTagName('img');
  for (let image of images) {
    // add BS classes. Won't be needed once migration away from BS is complete
    image.classList.add('img-responsive', 'center-block')

    // old handling for lazy loading images
    let lazySrc = image.getAttribute('data-src');
    if (lazySrc) {
      image.src = lazySrc;
    }

  }</script><script>const preTags = Array.from(document.getElementsByTagName('pre'));
      preTags.forEach((i, block) => {
        hljs.highlightBlock(i);
      });</script></body></html>